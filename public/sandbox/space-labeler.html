<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Room Labeler</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .image-container {
            position: relative;
            display: inline-block;
        }

        .marker {
            position: absolute;
            background: #ff3b30;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
        }

        .label-text {
            position: absolute;
            background: white;
            padding: 3px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
            transform: translate(-50%, -120%);
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="topbar">
        <h2>Warehouse 231 ‚Äî Image Labeler</h2>
        <nav class="menu">
            <a href="/sandbox/items.html">üì¶ Items</a>
            <a href="/sandbox/spaces.html">üè† Spaces</a>
        </nav>
    </div>

    <div class="content-wrapper">
        <h1 id="roomTitle"></h1>
        <div class="image-container" id="imgContainer">
            <img id="roomImg" src="" style="max-width:800px; border-radius:8px;" />
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const spaceId = urlParams.get("id");
        const roomName = urlParams.get("name");
        document.getElementById("roomTitle").textContent = roomName;

        async function loadRoomImage() {
            const res = await fetch(`/api/spaces?client_id=1`);
            const spaces = await res.json();
            const space = spaces.find(s => s.space_id == spaceId);
            if (space?.image_url) document.getElementById("roomImg").src = space.image_url;
        }

        async function loadLabels() {
            const res = await fetch(`/api/spaces/${spaceId}/labels`);
            const labels = await res.json();
            const container = document.getElementById("imgContainer");
            container.querySelectorAll(".marker").forEach(m => m.remove());

            labels.forEach(l => {
                const marker = document.createElement("div");
                marker.className = "marker";
                marker.style.left = l.x_percent + "%";
                marker.style.top = l.y_percent + "%";

                // When clicked ‚Äî show item info window
                marker.onclick = () => openLabelInfo(l);

                const tooltip = document.createElement("div");
                tooltip.className = "label-text";
                tooltip.innerText = l.label_text || l.description || "Unnamed";
                marker.appendChild(tooltip);

                container.appendChild(marker);
            });
        }

        // ============================================================
        // Open info window when clicking a label marker
        // ============================================================
        async function openLabelInfo(label) {
            const modal = document.createElement("div");
            modal.style.position = "fixed";
            modal.style.left = 0;
            modal.style.top = 0;
            modal.style.width = "100%";
            modal.style.height = "100%";
            modal.style.background = "rgba(0,0,0,0.4)";
            modal.style.display = "flex";
            modal.style.justifyContent = "center";
            modal.style.alignItems = "center";
            modal.style.zIndex = 9999;

            const box = document.createElement("div");
            box.style.background = "#fff";
            box.style.padding = "20px 25px";
            box.style.borderRadius = "10px";
            box.style.boxShadow = "0 3px 8px rgba(0,0,0,0.2)";
            box.style.width = "400px";
            box.style.textAlign = "left";
            box.innerHTML = `<h3 style="margin-top:0;">Item Details</h3>
    <p><i>Loading item details...</i></p>`;

            modal.appendChild(box);
            document.body.appendChild(modal);

            try {
                const res = await fetch(`/api/items/byid/${label.item_id}`);
                const item = await res.json();

                if (!res.ok) {
                    box.innerHTML = `<h3>Item Details</h3>
        <p style="color:red;">Item not found or missing link.</p>`;
                } else {
                    box.innerHTML = `
        <h3 style="margin-top:0;">${item.description || "(no description)"}</h3>
        <p><b>Brand:</b> ${item.brand || "‚Äî"}</p>
        <p><b>Model:</b> ${item.model || "‚Äî"}</p>
        <p><b>Quantity:</b> ${item.quantity || 1}</p>
        <p><b>Unit RCV:</b> ${item.unit_rcv ? "$" + Number(item.unit_rcv).toFixed(2) : "‚Äî"}</p>
        <p><b>Extended RCV:</b> ${item.extended_rcv ? "$" + Number(item.extended_rcv).toFixed(2) : "‚Äî"}</p>
        <p><b>ACV %:</b> ${item.acv_percent ? item.acv_percent + "%" : "‚Äî"}</p>
        <p><b>ACV:</b> ${item.acv ? "$" + Number(item.acv).toFixed(2) : "‚Äî"}</p>
        <p><b>Notes:</b> ${item.notes || "‚Äî"}</p>
        <hr>
        <p><b>Coordinates:</b> ${Number(label.x_percent).toFixed(1)}%, ${Number(label.y_percent).toFixed(1)}%</p>
      `;
                }
            } catch (err) {
                console.error("Item fetch error:", err);
                box.innerHTML = `<h3>Item Details</h3><p style="color:red;">Error loading item.</p>`;
            }

            // --- Delete & Close Buttons
            const btnContainer = document.createElement("div");
            btnContainer.style.textAlign = "right";
            btnContainer.style.marginTop = "15px";

            const delBtn = document.createElement("button");
            delBtn.textContent = "üóë Delete Label";
            delBtn.style.background = "#d9534f";
            delBtn.style.color = "#fff";
            delBtn.style.border = "none";
            delBtn.style.padding = "6px 12px";
            delBtn.style.borderRadius = "5px";
            delBtn.style.cursor = "pointer";

            delBtn.onclick = async () => {
                if (!confirm("Delete this label?")) return;
                const res = await fetch(`/api/spaces/${spaceId}/labels/${label.label_id}`, { method: "DELETE" });
                if (res.ok) {
                    document.body.removeChild(modal);
                    loadLabels();
                } else {
                    alert("Delete failed.");
                }
            };

            const closeBtn = document.createElement("button");
            closeBtn.textContent = "Close";
            closeBtn.style.marginLeft = "10px";
            closeBtn.onclick = () => document.body.removeChild(modal);

            btnContainer.appendChild(delBtn);
            btnContainer.appendChild(closeBtn);
            box.appendChild(btnContainer);
        }



        document.getElementById("roomImg").addEventListener("click", async (e) => {
            const rect = e.target.getBoundingClientRect();
            const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
            const yPercent = ((e.clientY - rect.top) / rect.height) * 100;

            // Get room items
            const itemsRes = await fetch(`/api/items?room=${encodeURIComponent(roomName)}`);
            const { items } = await itemsRes.json();

            if (!items.length) return alert("No items found in this room.");

            // Build dropdown menu dynamically
            const menu = document.createElement("select");
            menu.innerHTML = `<option value="">Select item...</option>` +
                items.map(i =>
                    `<option value="${i.line_number}">${i.description || "(no description)"} ‚Äî ${i.brand || ""}</option>`
                ).join("");

            const modal = document.createElement("div");
            modal.style.position = "fixed";
            modal.style.left = 0;
            modal.style.top = 0;
            modal.style.width = "100%";
            modal.style.height = "100%";
            modal.style.background = "rgba(0,0,0,0.4)";
            modal.style.display = "flex";
            modal.style.justifyContent = "center";
            modal.style.alignItems = "center";

            const box = document.createElement("div");
            box.style.background = "#fff";
            box.style.padding = "20px";
            box.style.borderRadius = "8px";
            box.style.textAlign = "center";
            box.innerHTML = `<h3>Select item for this location</h3>`;
            box.appendChild(menu);

            const saveBtn = document.createElement("button");
            saveBtn.textContent = "Save Label";
            saveBtn.style.marginTop = "10px";
saveBtn.onclick = async () => {
  const val = menu.value;
  if (!val) return alert("Please select an item.");
  const item = items.find(i => i.line_number == val);

  if (!item?.id) {
    alert("Item ID missing ‚Äî please reload the page.");
    return;
  }

  await fetch(`/api/spaces/${spaceId}/labels`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      item_id: item.id,   // ‚úÖ use internal database ID
      x_percent: xPercent,
      y_percent: yPercent,
      label_text: item.description || "(no description)",
    }),
  });

  document.body.removeChild(modal);
  loadLabels();
};



            const cancelBtn = document.createElement("button");
            cancelBtn.textContent = "Cancel";
            cancelBtn.style.marginLeft = "10px";
            cancelBtn.onclick = () => document.body.removeChild(modal);

            box.appendChild(document.createElement("br"));
            box.appendChild(saveBtn);
            box.appendChild(cancelBtn);
            modal.appendChild(box);
            document.body.appendChild(modal);
        });

        loadRoomImage();
        loadLabels();
    </script>

</body>

</html>